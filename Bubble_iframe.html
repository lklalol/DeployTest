<style>
#unityIframe {
  width: 100%;
  height: 100%;
  border: 0;
  padding: 0;
  margin: 0;
  display: block;
}
</style>

<iframe 
  id="unityIframe" 
  src="https://lklalol.github.io/DeployTest/index.html"
  allow="fullscreen"
  style="width:100%; height:100%; border:0; overflow:hidden;">
</iframe>

<script>
var unitySceneLoaded = false;

window.addEventListener('message', function(event) {
  // ã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†ã®å‡¦ç†
  if (event.data && event.data.type === 'SceneLoaded') {
    unitySceneLoaded = true;
    console.log("âœ… Unityã‚·ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ");
  }

  // Timelineé€²æ—æ›´æ–°å‡¦ç†ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨é€£å‹•ï¼‰
  if (event.data && (event.data.type === 'TimelineProgress' || event.data.type === 'UpdateBubbleSlider')) {
    let normalizedValue = parseFloat(event.data.normalizedValue || event.data.normalizedTime);
    if (isNaN(normalizedValue)) normalizedValue = 0;

    if (window.bubble_fn_timelinePosition) {
      window.bubble_fn_timelinePosition(normalizedValue * 100);
    } else {
      console.warn("âš ï¸ bubble_fn_timelinePositionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚JavaScript to Bubbleã®è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  }

  // Unityã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¦æ±‚å‡¦ç†
  if (event.data && event.data.action === 'RequestFileUpload') {
    if (typeof unityInstance !== 'undefined') {
      unityInstance.SendMessage('WebMessageReceiver', 'RequestFileUpload');
      console.log("âœ… Unityã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¦æ±‚ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    } else {
      console.error("âš ï¸ unityInstanceãŒæœªå®šç¾©ã§ã™ã€‚UnityãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„");
    }
  }

  // éŒ²ç”»æ™‚ã®iframeã®ã‚µã‚¤ã‚ºå¤‰æ›´
  if (event.data && event.data.type === 'SetIframeResolution') {
    const iframe = document.getElementById('unityIframe');
    if (!iframe) return;

    if (event.data.width > 0 && event.data.height > 0) {
      // ğŸ¥ éŒ²ç”»é–‹å§‹ï¼šãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã§å›ºå®š
      iframe.style.width = event.data.width + 'px';
      iframe.style.height = event.data.height + 'px';
      console.log(`ğŸ–¼ï¸ iframeã‚µã‚¤ã‚ºã‚’ ${event.data.width}x${event.data.height} ã«å¤‰æ›´`);
    } else {

      // âœ… iframeã‚µã‚¤ã‚ºã‚’å®Œå…¨ã«åˆæœŸåŒ–
      iframe.classList.remove('fixedSize'); // å¿µã®ãŸã‚
      iframe.style.removeProperty('width');
      iframe.style.removeProperty('height');
      iframe.removeAttribute('width');
      iframe.removeAttribute('height');
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      console.log("â†©ï¸ iframeã‚µã‚¤ã‚ºã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã—ãŸ");

      // âœ… è¦ªã® wrapper é«˜ã•ã‚‚ãƒªã‚»ãƒƒãƒˆ
      const wrapper = document.getElementById('unityIframeWrapper');
      if (wrapper) {
          wrapper.style.removeProperty('height');
          wrapper.style.height = '100%';
          console.log("â†©ï¸ è¦ª wrapper ã®é«˜ã•ã‚’ 100% ã«æˆ»ã—ã¾ã—ãŸ");
          console.log("ğŸ“ wrapper computed height:", wrapper.offsetHeight);
      }

      // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§iframeã®é«˜ã•ç¢ºèª
      console.log("ğŸ“ iframe computed height:", iframe.offsetHeight);
      }
    }
  });

// Unityã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆå†ç”Ÿã€åœæ­¢ã€ã‚·ãƒ¼ã‚¯ãªã©ï¼‰
function sendUnityMessage(message) {
  if (unitySceneLoaded) {
    document.getElementById('unityIframe').contentWindow.postMessage(message, '*');
  } else {
    console.warn("âš ï¸ Unityã‚·ãƒ¼ãƒ³ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼");
  }
}

// å†ç”Ÿåˆ¶å¾¡ç”¨é–¢æ•°ï¼ˆã“ã‚Œã‚‰ã¯Bubbleã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ã¾ã™ï¼‰
function PlayTimeline() { sendUnityMessage({ action: "PlayTimeline" }); }
function PauseTimeline() { sendUnityMessage({ action: "PauseTimeline" }); }
function StopTimeline() { sendUnityMessage({ action: "StopTimeline" }); }
function SeekTimeline(normalizedTime) { sendUnityMessage({ action: "SeekTimeline", normalizedTime }); }
</script>