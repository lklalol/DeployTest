<style>
#unityIframe {
  width: 100%;
  height: 100%;
  border: 0;
  padding: 0;
  margin: 0;
  display: block;
}
</style>

<iframe 
  id="unityIframe" 
  src="https://lklalol.github.io/DeployTest/index.html"
  allow="fullscreen"
  style="width:100%; height:100%; border:0; overflow:hidden;">
</iframe>

<script>
var unitySceneLoaded = false;

window.addEventListener('message', function(event) {
  // シーン読み込み完了の処理
  if (event.data && event.data.type === 'SceneLoaded') {
    unitySceneLoaded = true;
    console.log("✅ Unityシーンの読み込みが完了しました");
  }

  // Timeline進捗更新処理（スライダーと連動）
  if (event.data && (event.data.type === 'TimelineProgress' || event.data.type === 'UpdateBubbleSlider')) {
    let normalizedValue = parseFloat(event.data.normalizedValue || event.data.normalizedTime);
    if (isNaN(normalizedValue)) normalizedValue = 0;

    if (window.bubble_fn_timelinePosition) {
      window.bubble_fn_timelinePosition(normalizedValue * 100);
    } else {
      console.warn("⚠️ bubble_fn_timelinePositionが見つかりません。JavaScript to Bubbleの設定を再確認してください。");
    }
  }

  // Unityへのファイルアップロード要求処理
  if (event.data && event.data.action === 'RequestFileUpload') {
    if (typeof unityInstance !== 'undefined') {
      unityInstance.SendMessage('WebMessageReceiver', 'RequestFileUpload');
      console.log("✅ Unityにアップロード要求を送信しました");
    } else {
      console.error("⚠️ unityInstanceが未定義です。Unityがロードされているか確認してください");
    }
  }

  // 録画時のiframeのサイズ変更
  if (event.data && event.data.type === 'SetIframeResolution') {
    const iframe = document.getElementById('unityIframe');
    if (!iframe) return;

    if (event.data.width > 0 && event.data.height > 0) {
      // 🎥 録画開始：ピクセルサイズで固定
      iframe.style.width = event.data.width + 'px';
      iframe.style.height = event.data.height + 'px';
      console.log(`🖼️ iframeサイズを ${event.data.width}x${event.data.height} に変更`);
    } else {

      // ✅ iframeサイズを完全に初期化
      iframe.classList.remove('fixedSize'); // 念のため
      iframe.style.removeProperty('width');
      iframe.style.removeProperty('height');
      iframe.removeAttribute('width');
      iframe.removeAttribute('height');
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      console.log("↩️ iframeサイズを初期値に戻しました");

      // ✅ 親の wrapper 高さもリセット
      const wrapper = document.getElementById('unityIframeWrapper');
      if (wrapper) {
          wrapper.style.removeProperty('height');
          wrapper.style.height = '100%';
          console.log("↩️ 親 wrapper の高さを 100% に戻しました");
          console.log("📏 wrapper computed height:", wrapper.offsetHeight);
      }

      // ✅ デバッグログでiframeの高さ確認
      console.log("📏 iframe computed height:", iframe.offsetHeight);
      }
    }
  });

// Unityへメッセージを送信する関数（再生、停止、シークなど）
function sendUnityMessage(message) {
  if (unitySceneLoaded) {
    document.getElementById('unityIframe').contentWindow.postMessage(message, '*');
  } else {
    console.warn("⚠️ Unityシーンがまだ読み込まれていません！");
  }
}

// 再生制御用関数（これらはBubbleのボタンから呼び出します）
function PlayTimeline() { sendUnityMessage({ action: "PlayTimeline" }); }
function PauseTimeline() { sendUnityMessage({ action: "PauseTimeline" }); }
function StopTimeline() { sendUnityMessage({ action: "StopTimeline" }); }
function SeekTimeline(normalizedTime) { sendUnityMessage({ action: "SeekTimeline", normalizedTime }); }
</script>