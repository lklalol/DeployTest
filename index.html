<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | 3D Canva</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background: #231F20;
        }

        #unity-canvas {
            width: 100%;
            height: 100vh;
            display: block;
            background: #231F20;
        }
    </style>
</head>
<body>
    <canvas id="unity-canvas" width="100%" height="100%" style="width:100vw; height:100vh;"></canvas>
    <button onclick="microRepaint()" style="position:fixed;top:10px;right:10px;z-index:9999;">
        🩺 Micro Repaint
    </button>

    <script src="Build/Build.loader.js"></script>
    <script>
        var unityInstance = null;

        createUnityInstance(document.querySelector("#unity-canvas"), {
            dataUrl: "Build/Build.data",
            frameworkUrl: "Build/Build.framework.js",
            codeUrl: "Build/Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "My project (1)",
            productVersion: "0.1",
            matchWebGLToCanvasSize: false,
        }).then((instance) => {
            unityInstance = instance;
            window.parent.postMessage({ type: 'UnityReady' }, '*');

        });

        let resizeTimeout = null;

        function updateCanvasResolution() {
            clearTimeout(resizeTimeout);

            resizeTimeout = setTimeout(() => {
                var canvas = document.getElementById("unity-canvas");

                var displayWidth = canvas.clientWidth;
                var displayHeight = canvas.clientHeight;

                var dpr = Math.min(Math.max(window.devicePixelRatio, 0.5), 1.5);

                var renderWidth = Math.round(displayWidth * dpr);
                var renderHeight = Math.round(displayHeight * dpr);

                // Canvasのサイズが既に同じなら更新しない（安全策）
                if (canvas.width === renderWidth && canvas.height === renderHeight) {
                    return;
                }

                canvas.width = renderWidth;
                canvas.height = renderHeight;

                var gl = canvas.getContext("webgl") || canvas.getContext("webgl2");
                if (gl) {
                    gl.viewport(0, 0, renderWidth, renderHeight);
                    console.log(`✅ Canvas解像度同期: ${renderWidth}x${renderHeight} (dpr:${dpr})`);

                    if (unityInstance) {
                        unityInstance.SendMessage("CanvasResolutionManager", "OnCanvasResolutionChanged", JSON.stringify({ width: renderWidth, height: renderHeight }));
                    }
                }
            }, 200); // 💡 200msのディレイを挟んで安定させる
        }

        window.addEventListener('load', updateCanvasResolution);
        window.addEventListener('resize', updateCanvasResolution);


        // 録画専用の解像度変更用（RecordingManagerから呼び出す）
        function SetCanvasResolution(width, height) {
            var canvas = document.getElementById("unity-canvas");
            canvas.width = width;
            canvas.height = height;

            var gl = canvas.getContext("webgl") || canvas.getContext("webgl2");
            if (gl) {
                gl.viewport(0, 0, width, height);
                console.log("✅ 録画用にCanvas解像度設定: " + width + "x" + height);
            }
        }

        function SceneLoadCompleted() {
            window.parent.postMessage({ type: 'SceneLoaded' }, '*');
            console.log("✅ シーンの読み込みが完了しました (Unity → Web)");
        }

        function SendRecordingStart() {
            window.parent.postMessage({ type: 'Recording', action: 'Start' }, '*');
            console.log("✅ Unity → ブラウザ (録画開始)");
        }

        function SendRecordingStop() {
            window.parent.postMessage({ type: 'Recording', action: 'Stop' }, '*');
            console.log("✅ Unity → ブラウザ (録画停止)");
        }

        window.addEventListener('message', function (event) {
            if (event.data) {

                // アスペクト比送信
                if (event.data.type === 'SetAspectRatioByLabel') {
                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("GamePreviewView", "OnReceiveResolution", JSON.stringify(event.data));
                        console.log("✅ Unityにアスペクト比メッセージを送信しました:", event.data);
                    } else {
                        console.warn("⚠️ unityInstanceがまだ定義されていません");
                    }
                }

                // Bubble側からのアセット読み込み要求
                if (event.data.type === 'LoadUnityAsset') {
                    var assetId = event.data.assetId;
                    unityInstance.SendMessage("SupabaseManager", "LoadAssetById", assetId);
                }

                // Timeline操作 (再生、停止など)
                if (event.data.action === 'PlayTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalPlay");
                }
                if (event.data.action === 'PauseTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalPause");
                }
                if (event.data.action === 'StopTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalStop");
                }
                if (event.data.action === 'SeekTimeline') {
                    var normalizedTime = parseFloat(event.data.normalizedTime);
                    if (isNaN(normalizedTime)) normalizedTime = 0;
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalSetTime", normalizedTime);
                }

                // ファイルアップロード処理
                if (event.data.action === "RequestFileUpload") {
                    let mediaType = event.data.mediaType;

                    if (typeof mediaType === 'string' && mediaType.length > 0) {
                        unityInstance.SendMessage("WebMessageReceiver", "RequestFileUpload", mediaType);
                        console.log("✅ Unityにメッセージを送信しました。mediaType:", mediaType);
                    } else {
                        console.error("❌ mediaTypeが正しくありません:", mediaType);
                    }
                }

                // 解像度設定
                if (event.data.type === 'SetResolution') {
                    console.log("📨 iframe内で解像度メッセージ受信完了:", event.data);

                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("RecordingManager", "OnReceiveResolution", JSON.stringify(event.data));
                        console.log("✅ Unityスクリプトに解像度メッセージ送信しました");
                    } else {
                        console.warn("⚠️ unityInstanceがまだ定義されていません");
                    }
                }

                // 録画処理
                if (event.data.type === 'Recording') {
                    console.log("📨 iframe内で録画メッセージ受信完了:", event.data);

                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("RecordingManager", "OnReceiveRecordingMessage", JSON.stringify(event.data));
                        console.log("✅ Unityスクリプトに録画メッセージ送信しました");
                    } else {
                        console.warn("⚠️ unityInstanceがまだ定義されていません");
                    }
                }
            }
        });

        function microRepaint() {
            const canvas = document.getElementById('unity-canvas');
            if (!canvas) return;

            const originalMargin = canvas.style.marginTop || '0px';

            // 💥 margin で画面レイアウトを物理的に変化させる
            canvas.style.marginTop = '1px';
            canvas.offsetHeight; // 強制リフロー
            setTimeout(() => {
                canvas.style.marginTop = originalMargin;

                // resizeイベントも偽装で発火（追加刺激）
                window.dispatchEvent(new Event('resize'));

                console.log("🩺 microRepaint 発動：1px物理ズラしで再描画");
            }, 0);
        }
    </script>
</body>
</html>
