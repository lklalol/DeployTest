<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | 3D Canva</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background: #231F20;
        }

        #unity-canvas {
            width: 100%;
            height: 100vh;
            display: block;
            background: #231F20;
        }
    </style>
</head>
<body>
    <canvas id="unity-canvas" width="100%" height="100%" style="width:100vw; height:100vh;"></canvas>
    <button onclick="microRepaint()" style="position:fixed;top:10px;right:10px;z-index:9999;">
        ğŸ©º Micro Repaint
    </button>

    <script src="Build/Build.loader.js"></script>
    <script>
        var unityInstance = null;
        var unityLoaded = false; // Unityã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ•ãƒ©ã‚°

        createUnityInstance(document.querySelector("#unity-canvas"), {
            dataUrl: "Build/Build.data",
            frameworkUrl: "Build/Build.framework.js",
            codeUrl: "Build/Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "My project (1)",
            productVersion: "0.1",
            matchWebGLToCanvasSize: false,
        }).then((instance) => {
            unityInstance = instance;
        });

        // Canvasã‚µã‚¤ã‚ºã®å®‰å…¨ãªå¤‰æ›´å‡¦ç†ï¼ˆUnityãƒ­ãƒ¼ãƒ‰å¾Œã®ã¿è¨±å¯ï¼‰
        let resizeTimeout = null;

        function updateCanvasResolution() {
            if (!unityLoaded) {
                console.log("ğŸš§ Unityæœªãƒ­ãƒ¼ãƒ‰: ã‚µã‚¤ã‚ºå¤‰æ›´ã‚’ã‚¹ã‚­ãƒƒãƒ—");
                return; // Unityæœªãƒ­ãƒ¼ãƒ‰ã®é–“ã¯ä½•ã‚‚ã—ãªã„
            }

            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                var canvas = document.getElementById("unity-canvas");
                var displayWidth = canvas.clientWidth;
                var displayHeight = canvas.clientHeight;
                var dpr = Math.min(Math.max(window.devicePixelRatio, 0.5), 1.5);

                var renderWidth = Math.round(displayWidth * dpr);
                var renderHeight = Math.round(displayHeight * dpr);

                if (canvas.width === renderWidth && canvas.height === renderHeight) {
                    return;
                }

                canvas.width = renderWidth;
                canvas.height = renderHeight;

                var gl = canvas.getContext("webgl2") || canvas.getContext("webgl");
                if (gl) {
                    gl.viewport(0, 0, renderWidth, renderHeight);
                    console.log(`âœ… Canvasè§£åƒåº¦åŒæœŸ: ${renderWidth}x${renderHeight} (dpr:${dpr})`);

                    unityInstance.SendMessage("CanvasResolutionManager", "OnCanvasResolutionChanged", JSON.stringify({ width: renderWidth, height: renderHeight }));
                } else {
                    console.error("âŒ WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            }, 200);
        }

        // èµ·å‹•æ™‚ã«åˆæœŸCanvasã‚µã‚¤ã‚ºã‚’å›ºå®šï¼ˆå®‰å®šåŒ–ã®ãŸã‚ï¼‰
        window.addEventListener('load', () => {
            var canvas = document.getElementById("unity-canvas");
            canvas.width = 1280;
            canvas.height = 720;
            console.log("ğŸ”’ èµ·å‹•æ™‚Canvasã‚µã‚¤ã‚ºåˆæœŸå›ºå®š: 1280x720");
        });

        // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã‚‚Unityãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã®ã¿åæ˜ 
        window.addEventListener('resize', updateCanvasResolution);

        // éŒ²ç”»å°‚ç”¨ã®è§£åƒåº¦å¤‰æ›´ç”¨ï¼ˆRecordingManagerã‹ã‚‰å‘¼ã³å‡ºã™ï¼‰
        function SetCanvasResolution(width, height) {
            var canvas = document.getElementById("unity-canvas");
            canvas.width = width;
            canvas.height = height;

            var gl = canvas.getContext("webgl") || canvas.getContext("webgl2");
            if (gl) {
                gl.viewport(0, 0, width, height);
                console.log("âœ… éŒ²ç”»ç”¨ã«Canvasè§£åƒåº¦è¨­å®š: " + width + "x" + height);
            }
        }

        function SceneLoadCompleted() {
            window.parent.postMessage({ type: 'SceneLoaded' }, '*');
            console.log("âœ… ã‚·ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ (Unity â†’ Web)");
        }

        function SendRecordingStart() {
            window.parent.postMessage({ type: 'Recording', action: 'Start' }, '*');
            console.log("âœ… Unity â†’ ãƒ–ãƒ©ã‚¦ã‚¶ (éŒ²ç”»é–‹å§‹)");
        }

        function NotifyRecordingStoppedToJS() {
            console.log("âœ… Unityã‹ã‚‰éŒ²ç”»çµ‚äº†é€šçŸ¥å—ä¿¡ã€‚Canvaså†èª¿æ•´é–‹å§‹");
            updateCanvasResolution();
        }

        window.NotifyRecordingStoppedToJS = NotifyRecordingStoppedToJS;

        function SendRecordingStop() {
            window.parent.postMessage({ type: 'Recording', action: 'Stop' }, '*');
            console.log("âœ… Unity â†’ ãƒ–ãƒ©ã‚¦ã‚¶ (éŒ²ç”»åœæ­¢)");
        }

        window.addEventListener('message', function (event) {
            if (event.data) {
                // Unityãƒ­ãƒ¼ãƒ‰å®Œäº†é€šçŸ¥
                if (event.data.type === 'SceneLoaded') {
                    unityLoaded = true;
                    console.log("âœ… Unityå´ã‹ã‚‰SceneLoadedé€šçŸ¥å—ä¿¡ã€‚Canvasã‚µã‚¤ã‚ºèª¿æ•´ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
                    updateCanvasResolution();
                }

                // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”é€ä¿¡
                if (event.data.type === 'SetAspectRatioByLabel') {
                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("GamePreviewView", "OnReceiveResolution", JSON.stringify(event.data));
                        console.log("âœ… Unityã«ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ:", event.data);
                    } else {
                        console.warn("âš ï¸ unityInstanceãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    }
                }

                // Bubbleå´ã‹ã‚‰ã®ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿è¦æ±‚
                if (event.data.type === 'LoadUnityAsset') {
                    var assetId = event.data.assetId;
                    unityInstance.SendMessage("SupabaseManager", "LoadAssetById", assetId);
                }

                // Timelineæ“ä½œ (å†ç”Ÿã€åœæ­¢ãªã©)
                if (event.data.action === 'PlayTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalPlay");
                }
                if (event.data.action === 'PauseTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalPause");
                }
                if (event.data.action === 'StopTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalStop");
                }
                if (event.data.action === 'SeekTimeline') {
                    var normalizedTime = parseFloat(event.data.normalizedTime);
                    if (isNaN(normalizedTime)) normalizedTime = 0;
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalSetTime", normalizedTime);
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                if (event.data.action === "RequestFileUpload") {
                    let mediaType = event.data.mediaType;
                    if (typeof mediaType === 'string' && mediaType.length > 0) {
                        unityInstance.SendMessage("WebMessageReceiver", "RequestFileUpload", mediaType);
                        console.log("âœ… Unityã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚mediaType:", mediaType);
                    } else {
                        console.error("âŒ mediaTypeãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“:", mediaType);
                    }
                }

                // è§£åƒåº¦è¨­å®š
                if (event.data.type === 'SetResolution') {
                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("RecordingManager", "OnReceiveResolution", JSON.stringify(event.data));
                        console.log("âœ… Unityã‚¹ã‚¯ãƒªãƒ—ãƒˆã«è§£åƒåº¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ã¾ã—ãŸ");
                    } else {
                        console.warn("âš ï¸ unityInstanceãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    }
                }

                // éŒ²ç”»å‡¦ç†
                if (event.data.type === 'Recording') {
                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("RecordingManager", "OnReceiveRecordingMessage", JSON.stringify(event.data));
                        console.log("âœ… Unityã‚¹ã‚¯ãƒªãƒ—ãƒˆã«éŒ²ç”»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ã¾ã—ãŸ");
                    } else {
                        console.warn("âš ï¸ unityInstanceãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    }
                }
            }
        });

        function microRepaint() {
            const canvas = document.getElementById('unity-canvas');
            if (!canvas) return;

            const originalMargin = canvas.style.marginTop || '0px';

            // ğŸ’¥ margin ã§ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç‰©ç†çš„ã«å¤‰åŒ–ã•ã›ã‚‹
            canvas.style.marginTop = '1px';
            canvas.offsetHeight; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
            setTimeout(() => {
                canvas.style.marginTop = originalMargin;

                // resizeã‚¤ãƒ™ãƒ³ãƒˆã‚‚å½è£…ã§ç™ºç«ï¼ˆè¿½åŠ åˆºæ¿€ï¼‰
                window.dispatchEvent(new Event('resize'));

                console.log("ğŸ©º microRepaint ç™ºå‹•ï¼š1pxç‰©ç†ã‚ºãƒ©ã—ã§å†æç”»");
            }, 0);
        }
    </script>
</body>
</html>
