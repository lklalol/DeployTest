<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | 3D Canva</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background: #231F20;
        }

        #unity-canvas {
            width: 100%;
            height: 100vh;
            display: block;
            background: #231F20;
        }
    </style>
</head>
<body>
    <canvas id="unity-canvas" width="100%" height="100%" style="width:100vw; height:100vh;"></canvas>
    <button onclick="nuclearRepaint()" style="position:fixed;top:10px;right:10px;z-index:9999;">
        ‚ò¢ Canvas Repaint
    </button>

    <script src="Build/Build.loader.js"></script>
    <script>
        var unityInstance = null;

        createUnityInstance(document.querySelector("#unity-canvas"), {
            dataUrl: "Build/Build.data",
            frameworkUrl: "Build/Build.framework.js",
            codeUrl: "Build/Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "My project (1)",
            productVersion: "0.1",
        }).then((instance) => {
            unityInstance = instance;
            window.parent.postMessage({ type: 'UnityReady' }, '*');
        });

        function SceneLoadCompleted() {
            window.parent.postMessage({ type: 'SceneLoaded' }, '*');
            console.log("‚úÖ „Ç∑„Éº„É≥„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü (Unity ‚Üí Web)");
        }

        function SendRecordingStart() {
            window.parent.postMessage({ type: 'Recording', action: 'Start' }, '*');
            console.log("‚úÖ Unity ‚Üí „Éñ„É©„Ç¶„Ç∂ (Èå≤ÁîªÈñãÂßã)");
        }

        function SendRecordingStop() {
            window.parent.postMessage({ type: 'Recording', action: 'Stop' }, '*');
            console.log("‚úÖ Unity ‚Üí „Éñ„É©„Ç¶„Ç∂ (Èå≤ÁîªÂÅúÊ≠¢)");
        }

        window.addEventListener('message', function (event) {
            if (event.data) {

                // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØîÈÄÅ‰ø°
                if (event.data.type === 'SetAspectRatioByLabel') {
                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("GamePreviewView", "OnReceiveResolution", JSON.stringify(event.data));
                        console.log("‚úÖ Unity„Å´„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü:", event.data);
                    } else {
                        console.warn("‚ö†Ô∏è unityInstance„Åå„Åæ„Å†ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    }
                }

                // BubbleÂÅ¥„Åã„Çâ„ÅÆ„Ç¢„Çª„ÉÉ„ÉàË™≠„ÅøËæº„ÅøË¶ÅÊ±Ç
                if (event.data.type === 'LoadUnityAsset') {
                    var assetId = event.data.assetId;
                    unityInstance.SendMessage("SupabaseManager", "LoadAssetById", assetId);
                }

                // TimelineÊìç‰Ωú (ÂÜçÁîü„ÄÅÂÅúÊ≠¢„Å™„Å©)
                if (event.data.action === 'PlayTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalPlay");
                }
                if (event.data.action === 'PauseTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalPause");
                }
                if (event.data.action === 'StopTimeline') {
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalStop");
                }
                if (event.data.action === 'SeekTimeline') {
                    var normalizedTime = parseFloat(event.data.normalizedTime);
                    if (isNaN(normalizedTime)) normalizedTime = 0;
                    unityInstance.SendMessage("WebMessageReceiver", "ExternalSetTime", normalizedTime);
                }

                // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
                if (event.data.action === "RequestFileUpload") {
                    let mediaType = event.data.mediaType;

                    if (typeof mediaType === 'string' && mediaType.length > 0) {
                        unityInstance.SendMessage("WebMessageReceiver", "RequestFileUpload", mediaType);
                        console.log("‚úÖ Unity„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇmediaType:", mediaType);
                    } else {
                        console.error("‚ùå mediaType„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì:", mediaType);
                    }
                }

                // Ëß£ÂÉèÂ∫¶Ë®≠ÂÆö
                if (event.data.type === 'SetResolution') {
                    console.log("üì® iframeÂÜÖ„ÅßËß£ÂÉèÂ∫¶„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°ÂÆå‰∫Ü:", event.data);

                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("RecordingManager", "OnReceiveResolution", JSON.stringify(event.data));
                        console.log("‚úÖ Unity„Çπ„ÇØ„É™„Éó„Éà„Å´Ëß£ÂÉèÂ∫¶„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü");
                    } else {
                        console.warn("‚ö†Ô∏è unityInstance„Åå„Åæ„Å†ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    }
                }

                // Èå≤ÁîªÂá¶ÁêÜ
                if (event.data.type === 'Recording') {
                    console.log("üì® iframeÂÜÖ„ÅßÈå≤Áîª„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°ÂÆå‰∫Ü:", event.data);

                    if (typeof unityInstance !== "undefined") {
                        unityInstance.SendMessage("RecordingManager", "OnReceiveRecordingMessage", JSON.stringify(event.data));
                        console.log("‚úÖ Unity„Çπ„ÇØ„É™„Éó„Éà„Å´Èå≤Áîª„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü");
                    } else {
                        console.warn("‚ö†Ô∏è unityInstance„Åå„Åæ„Å†ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    }
                }
            }
        });

        function nuclearRepaint() {
            const canvas = document.getElementById('unity-canvas');
            if (!canvas || !canvas.parentElement) return;

            const parent = canvas.parentElement;
            const next = canvas.nextSibling;

            // „Çµ„Ç§„Ç∫Â§âÊõ¥
            canvas.style.width = '99.9vw';
            canvas.style.height = '99.9vh';

            // „É™„Éï„É≠„Éº
            canvas.offsetHeight;

            // visibility„Éà„Ç∞„É´
            canvas.style.visibility = 'hidden';
            canvas.offsetHeight;

            // DOMÂÜçÊåøÂÖ•
            parent.removeChild(canvas);
            setTimeout(() => {
                canvas.style.width = '100vw';
                canvas.style.height = '100vh';
                canvas.style.visibility = 'visible';
                if (next) {
                    parent.insertBefore(canvas, next);
                } else {
                    parent.appendChild(canvas);
                }
                window.dispatchEvent(new Event('resize'));
                console.log("‚ò¢Ô∏è nuclearRepaint ÂÆå‰∫Ü");
            }, 0);
        }
    </script>
</body>
</html>
